<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.elbigs.mapper.FacilityMapper">
    <select id="selectFacilityDetailFo" resultType="java.util.HashMap">
        select s.id
             , case when all_time = true then '24시간 영업' else s.open_time|| '~' || s.close_time end as business_hours
             <if test="lang=='ko'">
             , s."name"
             , s.holiday as closed_day
             , s.tags
             , s.available_service
             </if>
             <if test="lang=='cn'">
             , s.cn_name as name
             , s.cn_holiday as closed_day
             , s.cn_tags tags
             , s.cn_available_service as available_service
             </if>
             <if test="lang=='en'">
             , s.en_name as name
             , s.en_holiday as closed_day
             , s.en_tags as tags
             , s.en_available_service as available_service
             </if>
             <if test="lang=='jp'">
             , s.jp_name as name
             , s.jp_holiday as closed_day
             , s.jp_tags as tags
             , s.jp_available_service as available_service
             </if>
        from facilities s where id = #{id}
    </select>
    <select id="selectFacilityList" resultType="com.elbigs.dto.FacilityDto">
        select s.id
             , s."name"
             , s.tel
             , s.addr ||' '|| s.addr_detail as addr
             , to_char(s.created_at , 'YYYY-MM-DD') as created_at
             , to_char(s.updated_at , 'YYYY-MM-DD') as updated_at
             , count(1) over() total_count
          from facilities s
         where s.user_id = #{userPk}
           and s.deleted_at is null
           <if test="searchStr!=null and searchStr!=''">
           and s.name like '%'|| #{searchStr} ||'%'
           </if>
           <if test="categoryId!=null and categoryId > 0">
           and exists ( select 1 from menu_category_facility mcs where mcs.facility_id = s.id and mcs.menu_category_id = #{categoryId} )
           </if>
         order by s.id
         limit #{length} offset #{beginNo}
    </select>
    <select id="selectFacility" resultType="com.elbigs.dto.FacilityDto">
        select id
             , user_id
             , status
             , name
             , en_name
             , cn_name
             , jp_name
             , tel
             , all_time
             , open_time
             , close_time
             , post_code
             , addr
             , addr_detail
             , addr_extra
             , holiday
             , en_holiday
             , cn_holiday
             , jp_holiday
             , tags
             , en_tags
             , cn_tags
             , jp_tags
             , available_service
             , en_available_service
             , cn_available_service
             , jp_available_service
             , created_at
             , updated_at
             , deleted_at
          from facilities s
         where id = #{id}
    </select>
    <insert id="insertFacility" parameterType="com.elbigs.entity.FacilityEntity">
        insert into facilities (
                       user_id
                     , status
                     , name
                     , en_name
                     , cn_name
                     , jp_name
                     , tel
                     , owner_name
                     , owner_phone
                     , business_number
                     , all_time
                     , open_time
                     , close_time
                     , post_code
                     , addr
                     , addr_detail
                     , addr_extra
                     , holiday
                     , en_holiday
                     , cn_holiday
                     , jp_holiday
                     , tags
                     , en_tags
                     , cn_tags
                     , jp_tags
                     , available_service
                     , en_available_service
                     , cn_available_service
                     , jp_available_service
                     , created_at )
        values (  #{userId}, #{status}, #{name}, #{enName}, #{cnName}, #{jpName}, #{tel}, #{ownerName}, #{ownerPhone}, #{businessNumber}, #{allTime}, #{openTime}, #{closeTime}, #{postCode}, #{addr}, #{addrDetail}, #{addrExtra}
                , #{holiday}, #{enHoliday}, #{cnHoliday}, #{jpHoliday}, #{tags}, #{enTags}, #{cnTags}, #{jpTags}, #{availableService}, #{enAvailableService}, #{cnAvailableService}, #{jpAvailableService},  now())
        <selectKey keyProperty="id" resultType="long" order="AFTER">
            select currval('facilities_id_seq')
        </selectKey>
    </insert>
   <update id="updateFacility">
           update facilities
           set user_id = #{userId}
             , status = #{status}
             , name = #{name}
             , en_name = #{enName}
             , cn_name = #{cnName}
             , jp_name = #{jpName}
             , tel = #{tel}
             , owner_name = #{ownerName}
             , owner_phone = #{ownerPhone}
             , business_number = #{businessNumber}
             , all_time = #{allTime}
             , open_time = #{openTime}
             , close_time = #{closeTime}
             , post_code = #{postCode}
             , addr = #{addr}
             , addr_detail = #{addrDetail}
             , addr_extra = #{addrExtra}
             , holiday = #{holiday}
             , en_holiday = #{enHoliday}
             , cn_holiday = #{cnHoliday}
             , jp_holiday = #{jpHoliday}
             , tags = #{tags}
             , en_tags = #{enTags}
             , cn_tags = #{cnTags}
             , jp_tags = #{jpTags}
             , available_service = #{availableService}
             , en_available_service = #{enAvailableService}
             , cn_available_service = #{cnAvailableService}
             , jp_available_service = #{jpAvailableService}
             , updated_at = now()
           where id = #{id}
    </update>
    <update id="deleteFacility">
       update facilities
          set deleted_at = now()
        where id = #{id}
    </update>
</mapper>
